$(document).ready(function(){
  //On click event for "Save environment" in Save Environment modal
  $('#graph-save').click(function(){
    var graphName = $('input#graph-name').val().trim();
    var keyPairName = $('input#graph-key-pair-name').val().trim();
    var securityGroupName = $('input#graph-security-group-name').val().trim();
    var attributes = { name: graphName, key_pair_name: keyPairName, security_group: securityGroupName };
    $('.graph-area').graphArea("save", attributes);
  });

  //On click event for "Save" button on graph toolbar during edit
  $('#graph-update').click(function(){
    var graphId = $(this).data("graphId");
    $('.graph-area').graphArea("update", graphId);
  });

  //On click event for "Provision" button on graph toolbar during edit
  $('#graph-provision').click(function(){
    var graphId = $(this).data("graphId");
    showLoading();
    $.ajax({
      url: '/provision_environment?id='+graphId,
      type: 'POST',
      dataType: "script",
      contentType: 'application/json',
      data : $('.graph-area').graphArea("getInstances"),
      complete: function(){
        hideLoading();
      }
    });
  });

  //On click of save environment, it should save respective environment
  $(".save_env").live('click', function() {
    var id = $(this).attr('id').split('_')[2];
    var branch = $('#branch_'+id).val();    
    var db_migrate = '0';
    if($('#db_migrate_'+id).is(':checked'))
       db_migrate = '1';    
    showLoading();
      $.ajax({
        url: '/update_environment?id='+id,
        type: 'PUT',
        dataType: "script",
        contentType: 'application/json',
        data: JSON.stringify({environment: {branch: branch ,db_migrate: db_migrate}}),
        complete: function(){
          hideLoading();
        }
      });
  });

});

//$(function(){
 //$("#graph-provision").click(function(){
 // var environment_id = $("[id^=stack-status-image-]").attr('id').split('-')[3];
  //check_stack_status(environment_id);
 //});
//});

//function check_stack_status(environment_id)
//{
//    setInterval(function(){
//      $.ajax({
//        url: '/environment_status?id='+environment_id,
//        type: 'GET'
//      });
//    }, <%#= VisualCloudConfig[:status_check_interval] * 1000 %>);
//}

 $(function() {
 if($("[id^=instance-label-]").length != 0)
 {
    $("[id^=instance-label-]").each(function(){
    var instance_label = $(this).text();
    var environment_id = $("[id^=stack-status-image-]").attr('id').split('-')[3];
    var label_id = $(this).attr('id');
    setInterval(function(){
      $.ajax({
        type: 'GET',
        url: '/instance_status',
        data: {name: instance_label, environment_id: environment_id, instance_label_id: label_id}
      });
    }, <%= VisualCloudConfig[:status_check_interval] * 2000 %>);
  });
 }
});

$(function() {
 if($('.stack-status').length != 0)
 {
    $('.stack-status').each(function(){
    var environment_id = $(this).attr("data-graph-id");
    var internal_status = setInterval(function(){
      $.ajax({
        url: '/environment_status?id='+environment_id,
        type: 'GET'
      });
    }, <%= VisualCloudConfig[:status_check_interval] * 1500 %>);

    var original_status = setInterval(function(){
      $.ajax({
        url: '/stack_status?id='+environment_id,
        type: 'GET'
      });
    }, <%= VisualCloudConfig[:status_check_interval] * 100000 %>);

  });
 }
});

$(document).ready(function(){
  if($("[id^=instance-label-]").length != 0)
 {
    $("[id^=instance-label-]").each(function(){
    var instance_label = $(this).text();
    var environment_id = $("[id^=stack-status-image-]").attr('id').split('-')[3];
    var label_id = $(this).attr('id');
      $.ajax({
        type: 'GET',
        url: '/instance_status',
        data: {name: instance_label, environment_id: environment_id, instance_label_id: label_id}
      });
  });
 }
});

function delete_instance(resource_type) {
  var instance_id = $('#'+resource_type+'-configuration').data('editElement');
  jsPlumb.removeAllEndpoints(instance_id);
  $('.graph-area').graphArea("removeInstanceFromStage", instance_id);
}
